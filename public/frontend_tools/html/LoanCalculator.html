<script type="text/javascript-lazy">
    var app = angular.module('ctw');
    app.controllerProvider.register('toolController', function ($scope) {

        var initial = {
            interest: undefined,
            terms: undefined,
            unit: "years",

            result: undefined,
            error: undefined
        }
        $scope.loan = angular.copy(initial);

        $scope.calculate = function () {
            var scope = $scope.loan;
            scope.error = undefined;

            if (validateDecimal(scope.amount) && validateDecimal(scope.interest) && validateDecimal(scope.terms) && scope.terms > 0 && scope.amount > 0) {
                scope.result = {
                    mothly: undefined,
                    total: undefined,
                    totalInterest: 0,
                    interestPercentage: 0
                };

                var r = scope.interest / 100 / 12;
                var n;

                if (scope.unit == "years") {
                    n = scope.terms * 12;
                } else if (scope.unit = "months") {
                    n = scope.terms;
                } else {
                    scope.error = 'Please select a valid term unit';
                    return;
                }

                if(r === 0){
                    scope.result.monthly = (scope.amount / n).toFixed(2);
                    scope.result.total = (scope.amount).toFixed(2);
                    return;
                }
                scope.result.monthly = ((r * scope.amount) / (1 - Math.pow(1 + r, -n))).toFixed(2);
                scope.result.total = (scope.result.monthly * n).toFixed(2);

                scope.result.totalInterest = (scope.result.total - scope.amount).toFixed(2);;
                scope.result.interestPercentage = (scope.result.totalInterest / scope.result.total * 100).toFixed(2);
            } else {
                scope.error = 'Missing or invalid Input';
            }
        }
        $scope.reset = function () {
            $scope.loan = angular.copy(initial);
        }

        var validateDecimal = function (decimal) {
            decimal = parseFloat(decimal);
            return angular.isNumber(decimal) && isFinite(decimal);
        }
        var log = function (n, base) {
            return Math.log(n) / (base ? Math.log(base) : 1);
        }
    })
    ;
</script>
<style>
    #form-wrapper {
        text-align: center;
    }

    #unit {
        width: 90px;
    }
    #terms{
        width: 100px;
    }
</style>
<h1>Loan Calculator</h1>
<div ng-controller="toolController">
    <div id="form-wrapper">
        <form class="pure-form pure-form-aligned" novalidate>
            <fieldset>
                <legend>Fill out the form and click calculate</legend>
                <div class="pure-control-group">
                    <label for="amount" class="label">Loan Amount</label>
                    <input id="amount" type="number" step="any" placeholder="amount"
                           ng-model="loan.amount"/>
                </div>
                <div class="pure-control-group">
                    <label for="interest" class="label">Interest Rate p.a. (&percnt;)</label>
                    <input id="interest" type="number" step="any" placeholder="%" ng-model="loan.interest"/>
                </div>
                <!-- TODO Falls die Input width tatsächlich immer 195 px ist den unit selector mit fixer größe neben das term-input feld packen-->
                <div class="pure-control-group">
                    <label for="terms" class="label">Loan Term</label>
                    <input id="terms" type="number" step="any" placeholder="term" ng-model="loan.terms"/>
                    <select id="unit" ng-model="loan.unit">
                        <option value="years" selected>Years</option>
                        <option value="months">Months</option>
                    </select>
                </div>
                <div>
                    <button class="pure-button pure-button-primary" ng-click="calculate()">Calculate
                    </button>
                    <button class="pure-button" type="reset" ng-click="reset()">Clear
                    </button>
                </div>
                <div class="alert" ng-show="loan.error !== undefined">
                    <div class="alert_inner">
                        <div class="alert_text">{{loan.error}}</div>
                        <div class="alert_dismiss" ng-click="loan.error = undefined">&times;</div>
                    </div>
                </div>
            </fieldset>
        </form>
    </div>
    <div ng-show="loan.result !== undefined">
        <p> The monthly payment is <b>{{loan.result.monthly}}</b>.</p>
        <p> The total amount paid is <b>{{loan.result.total}}</b>.</p>
        <p> <b>{{loan.result.totalInterest}}</b>, or <b>{{loan.result.interestPercentage}}&percnt;</b> of that is interest.</p>
    </div>
</div>
<hr/>
<div class="pure-g">
    <div class="pure-u-1 pure-u-md-1-3 text">
        <h4>How do I use this loan calculator?</h4>
        <p>
            Enter the amount of your loan or mortgage, the annual interest rate in percent and the loan term in years or months and click calculate. <br/>
            The loan calculator will then show you the monthly payment, the total amount paid and how much of the total amount is interest (In your currency and in percent).
        </p>
    </div>
    <div class="pure-u-1 pure-u-md-1-3 text">
        <h4>About this calculator</h4>
        <p>
            With this simple loan calculator you can calculate how much you need to pay if you borrow money to finance a car, house, college education etc.<br/>
            It can be used to determine the monthly payment needed to settle a loan, mortgage or lease in a given period of time.<br/>
            You can also use this calculator to calculate how much money sou can afford to borrow before not being able to pay the monthly rate.
        </p>
    </div>
    <div class="pure-u-1 pure-u-md-1-3 text">
        <h4>Who should use this?</h4>
        <p>
            If you are looking to take out a loan, a mortgage or a lease to buy a car, house or something else you can use
            this calculator to get an approximation on how much you will have to pay your bank considering the interest rate they offer.<br/>
            However, please remember that this calculator is not 100&percnt; accurate and that this site does not provide financial advice. For financial advice, please consult a financial adviser.
        </p>
    </div>
</div>


